// ============================================================
// ğŸ“Š TABLEAU DE BORD DYNAMIQUE & DONNÃ‰ES JSON
// ============================================================

$>titre("ğŸš€ INITIALISATION DU SYSTÃˆME")
$>dom_inject_banner("Connexion au serveur de donnÃ©es...", "#ffa000")
$>print("Connexion Ã©tablie. RÃ©cupÃ©ration des paquets...", "gray")

// Simulation d'un dÃ©lai rÃ©seau (Asynchrone)
$>wait(1500)
$>dom_inject_banner("Analyse des donnÃ©es en cours...", "#2196f3")

// ------------------------------------------------------------
// 1. MANIPULATION JSON & TABLEAUX
// ------------------------------------------------------------
$>titre("1. Traitement de DonnÃ©es JSON")

// Simulation d'une rÃ©ponse API (JSON brut)
$>var json_api = '[{"id":1,"nom":"Serveur Alpha","charge":45,"status":"ok"},{"id":2,"nom":"Serveur Beta","charge":82,"status":"warning"},{"id":3,"nom":"Serveur Gamma","charge":12,"status":"ok"},{"id":4,"nom":"Serveur Delta","charge":67,"status":"ok"}]'

// Parsing du JSON en objet utilisable
$>var data = $>json_parse($json_api)
$>print("Paquet reÃ§u : " + $>len($data) + " nÅ“uds dÃ©tectÃ©s.", "#9cdcfe")

// Initialisation des tableaux pour le graphique
$>var labels = []
$>var values = []
$>var total_load = 0

// ------------------------------------------------------------
// 2. BOUCLE FOR INTELLIGENTE
// ------------------------------------------------------------
$>print("Analyse dÃ©taillÃ©e des nÅ“uds :")

// Boucle sur les objets (Syntaxe : $>for(element, liste))
$>for(node, $data) {
    // Extraction des propriÃ©tÃ©s via $>get
    $>var nom = $>get($node, "nom")
    $>var cpu = $>get($node, "charge")
    $>var status = $>get($node, "status")
    
    // Logique conditionnelle (Couleur selon status)
    $>var color = "gray"
    $>if($cpu > 80) { $>var color = "#ff5252" }
    $>else { $>var color = "#b9f6ca" }
    
    $>print(" ğŸ–¥ï¸ " + $nom + " : " + $cpu + "% (" + $status + ")", $color)
    
    // Accumulation pour les stats
    $>var total_load = $>math($total_load + $cpu)
    
    // Remplissage des tableaux pour le graphique
    $>push($labels, $nom)
    $>push($values, $cpu)
}

// ------------------------------------------------------------
// 3. STATISTIQUES & MATHS
// ------------------------------------------------------------
$>var avg = $>math(round($total_load / $>len($data)))

$>print("-----------------------------------")
$>print("CHARGE MOYENNE DU CLUSTER : " + $avg + "%", "orange")

// ------------------------------------------------------------
// 4. VISUALISATION GRAPHIQUE (Chart.js intÃ©grÃ©)
// ------------------------------------------------------------
$>titre("2. Visualisation Temps RÃ©el")
$>chart_line($labels, $values, "Charge CPU (%)")

// ------------------------------------------------------------
// 5. SIMULATION TEMPS RÃ‰EL (Boucle + Wait)
// ------------------------------------------------------------
$>titre("3. Monitoring Live (5s)")

$>var tick = 1
$>repeat(5) {
    $>wait(1000) // Pause d'une seconde
    // GÃ©nÃ©ration de fausses variations
    $>var variation = $>random(-10, 10)
    $>var current = $>math($avg + $variation)
    
    $>print("â±ï¸ T+" + $tick + "s : Charge actuelle -> " + $current + "%")
    $>var tick = $>math($tick + 1)
}

$>dom_inject_banner("Cycle de surveillance terminÃ©", "#4caf50")
$>print("âœ… OpÃ©rations terminÃ©es avec succÃ¨s.", "lime")